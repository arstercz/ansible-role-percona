# auto generated by NodeManager::MySQL::ConfigTemplate(0.0.1), 
# edit at your own risks. Template args: 
#   hostid       = id
#   port         = {{ mysql_port }}
#   prefix       = /web/mysql/node{{ mysql_port }}
#   capabilities = xtradb innodb Percona55 bbu_raid_or_flash nodexx mha_node

# password file, read only by owner
!include .my.cnf

# only certain clients support default-character-set
[mysql]
prompt = 'mysql \u@[\h:\p \d] > '
default-character-set = {{ mysql_character_set }}
[mysqladmin]
default-character-set = {{ mysql_character_set }}
[mysqlcheck]
default-character-set = {{ mysql_character_set }}
[mysqldump]
default-character-set = {{ mysql_character_set }}
[mysqlimport]
default-character-set = {{ mysql_character_set }}
[mysqlshow]
default-character-set = {{ mysql_character_set }}

[client]
port = {{ mysql_port }}
socket = {{ mysql_socket }}

[mysqld_safe]

{% if mysql_log_error == 'syslog' or mysql_log == 'syslog' %}
syslog
syslog-tag = {{ mysql_port }}
{% endif %}
#numa support
{% if mysql_numa %}
numa_interleave = 1
innodb_buffer_pool_populate = 1
flush_caches=1
{% endif %}

{% if mysql_malloclib %}
malloc-lib={{ mysql_basedir }}/lib/mysql/libjemalloc.so
{% endif %}

# on instance per my.node.cnf
[mysqld]

# Logging configuration
{% if mysql_log_error == 'syslog' or mysql_log == 'syslog' %}
{% else %}
{% if mysql_log %}
log = {{ mysql_log }}
{% endif %}
log-error = {{ mysql_log_error }}
{% endif %}

# node specific settings
{% set host_id = (netaddress.split('.'))[-1]|int %}
{% if (host_id is defined and host_id > 0) %}
server-id = {{ host_id * (2**16) + mysql_port }} # {{ mysql_port  }}+({{ host_id }}<<16)
{% else %}
server-id = {{ mysql_server_id }}
{% endif %}

# chain specific settings
port = {{ mysql_port }}
datadir = {{ mysql_datadir }}
pid-file = {{ mysql_pid_file }}
socket = {{ mysql_socket }}

# common InnoDB/XtraDB setting
innodb_buffer_pool_size = {{ (ansible_memtotal_mb/3)|round|int }}M
innodb_additional_mem_pool_size = {{ mysql_innodb_additional_mem_pool_size }}
innodb_log_file_size = {{ mysql_innodb_log_file_size }}
innodb_log_buffer_size = {{ mysql_innodb_log_buffer_size }}
innodb_flush_log_at_trx_commit = {{ mysql_innodb_flush_log_at_trx_commit }}
innodb_flush_method = O_DIRECT
innodb_file_per_table = {{ mysql_innodb_file_per_table }}
innodb_stats_on_metadata = 0
innodb_read_io_threads = {{ mysql_innodb_read_io_threads }}
innodb_write_io_threads = {{ mysql_innodb_write_io_threads }}
innodb_lock_wait_timeout = {{ mysql_innodb_lock_wait_timeout }}
default-storage-engine = {{ mysql_default_storage_engine }}

{% if percona_ver == 51 %}
# Percona Server enhancements
#  http://www.percona.com/doc/percona-server
innodb_overwrite_relay_log_info = 1  # 5.5.10-20.1 renamed
innodb_lazy_drop_table = 1
innodb_pass_corrupt_table = 0  # 5.5.10-20.1 renamed
log_slow_verbosity = full
userstat_running = 1  # 5.5.10-20.1 renamed
{% elif percona_ver == 55 %}
#  Percona Server enhancements
#  http://www.percona.com/doc/percona-server
innodb_recovery_update_relay_log = 1  # 5.5.10-20.1 introduced
innodb_buffer_pool_restore_at_startup = 16  # 5.5 buffer pool restore
innodb_lazy_drop_table = 1  # 5.6 deprecated
innodb_corrupt_table_action = warn  # 5.5.10-20.1 introduced
log_slow_verbosity = full
userstat = 1  # 5.5.10-20.1 introduced
log_warnings_suppress = 1592
{% elif percona_ver == 56 %}
# Percona Server enhancements
#  http://www.percona.com/doc/percona-server
eq_range_index_dive_limit = 8  # performace for range list
query_cache_strip_comments = 1  # ignore comments in query cache
innodb_corrupt_table_action = warn  # 5.5.10-20.1 introduced
innodb_buffer_pool_load_at_startup = 1  # 5.6 buffer pool restore
innodb_buffer_pool_dump_at_shutdown = 1  # 5.6 buffer poll dump
log_slow_verbosity = full
userstat = 1  # 5.5.10-20.1 introduced
{% endif %}

# common settings
slave_skip_errors = {{ mysql_slave_skip_errors }}
expire_logs_days = {{ mysql_expire_logs_days }}
back_log = {{ mysql_back_log }}
max_connections = {{ mysql_max_connections }}  # should be easy job in a big server
max_connect_errors = {{ mysql_max_connect_errors }}
thread_cache_size = {{ mysql_thread_cache_size }}
table_open_cache = {{ mysql_table_open_cache }}  # table_cache is deprecated in 5.1.3
sort_buffer_size = {{ mysql_sort_buffer_size }}
read_buffer_size = {{ mysql_read_buffer_size }}
join_buffer_size = {{ mysql_join_buffer_size }}
read_rnd_buffer_size = {{ mysql_read_rnd_buffer_size }}
myisam_sort_buffer_size = {{ mysql_myisam_sort_buffer_size }}
query_cache_size = 0

wait_timeout = {{ mysql_wait_timeout }}
thread_concurrency = {{ mysql_thread_concurrency }}

read_only = 1 # start read only, turn it off on master  afterwards by 
              # 'SET GLOBAL read_only = 0'
max_allowed_packet = {{ mysql_max_allowed_packet }}
user = mysql
skip-external-locking  # a.k.a skip-locking
skip-name-resolve
skip-slave-start
character-set-server = {{ mysql_character_set }}  # default-character-set is deprecated in 5.0
collation-server = {{ mysql_general_ci }}
tmpdir = /dev/shm
log_output = FILE
{% if mysql_slow_query_log_enabled %}
slow_query_log = 1 
slow_query_log_file = {{ mysql_slow_query_log_file }}
long_query_time = {{ mysql_slow_query_time }}
{% endif %}
general_log = OFF
general_log_file = {{ mysql_general_log }}
log-bin = mysql-bin.log
sync_binlog = 1
sync_binlog = 1  # BBU-backed RAID or flash
relay-log = relay-bin.log  # auto purge by default, see relay-log-purge
relay-log-purge = 1  # MHA advise: 0
log-slave-updates
replicate-same-server-id = 0
binlog-ignore-db = mysql
binlog-ignore-db = test
binlog-ignore-db = information_schema
binlog-ignore-db = performance_schema
replicate-ignore-db = mysql
replicate-ignore-db = test
replicate-ignore-db = information_schema
replicate-ignore-db = performance_schema
